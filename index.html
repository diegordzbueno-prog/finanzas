<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0B0D14">
    <title>DiegoFi - Negocio</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{--bg:#0B0D14;--card:#13151E;--input:#1A1D27;--bdr:#1E2030;--bdr2:#2A2D3A;--t1:#F1F5F9;--t2:#E2E8F0;--t3:#CBD5E1;--t4:#94A3B8;--t5:#64748B;--t6:#475569;--ac:#22D3EE;--pu:#818CF8;--gn:#34D399;--rd:#FF6B6B;--yw:#FBBF24}
        html,body{height:100%;background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--t2);overflow-x:hidden}
        .hdr{padding:16px;position:sticky;top:0;z-index:100;background:var(--bg);display:flex;justify-content:space-between;align-items:center}
        .logo span{background:linear-gradient(135deg,var(--ac),var(--pu));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;font-size:20px}
        .cnt{padding:0 16px 100px}
        .cd{background:var(--card);border-radius:16px;padding:16px;border:1px solid var(--bdr);margin-bottom:12px}
        .ct{font-size:11px;color:var(--t5);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;display:flex;justify-content:space-between}
        .sg{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
        .sc{background:var(--card);border-radius:12px;padding:10px;border:1px solid var(--bdr);text-align:center}
        .sl{font-size:9px;color:var(--t5);margin-bottom:4px}
        .sv{font-size:13px;font-weight:700}
        .nav{position:fixed;bottom:0;left:0;right:0;height:75px;background:rgba(19,21,30,0.95);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:space-around;border-top:1px solid var(--bdr);z-index:1000}
        .nb{background:none;border:none;color:var(--t6);display:flex;flex-direction:column;align-items:center;font-size:10px;font-weight:600}
        .nb.on{color:var(--ac)}
        .ni{font-size:22px;margin-bottom:4px}
        .fab{width:50px;height:50px;border-radius:16px;background:linear-gradient(135deg,var(--ac),var(--pu));color:#fff;font-size:28px;border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(34,211,238,0.3)}
        .gdb{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:var(--input);font-size:10px;cursor:pointer}
        .gdd{width:7px;height:7px;border-radius:50%}.gdd.on{background:var(--gn)}.gdd.off{background:var(--rd)}
        .rep-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--bdr2);font-size:13px}
        .rep-row:last-child{border:none}
        .mo{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:flex-end;z-index:2000}
        .mbox{background:var(--card);width:100%;padding:24px;border-radius:24px 24px 0 0;max-height:85vh;overflow-y:auto;border-top:1px solid var(--bdr2)}
        .inp{width:100%;padding:14px;background:var(--input);border:1px solid var(--bdr2);border-radius:12px;color:#fff;margin-bottom:12px;font-size:15px;outline:none}
        .btn-s{width:100%;padding:16px;border-radius:12px;border:none;font-weight:700;background:var(--ac);color:var(--bg);font-size:16px}
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const GC = '1029204241098-s89a2jdmfjfbcmev4qgped8phnh971n2.apps.googleusercontent.com';
const DF = 'diegofi_data.json';
const DS = 'https://www.googleapis.com/auth/drive.file';

let S = {
    transactions: [],
    categories: {
        expense: [{id:'pollo_compra',name:'Compra Pollo',icon:'ðŸ—',color:'#FB923C'},{id:'food',name:'Comida',icon:'ðŸ”',color:'#FF6B6B'},{id:'serv',name:'Servicios',icon:'ðŸ’¡',color:'#FBBF24'},{id:'other',name:'Otros',icon:'ðŸ“¦',color:'#94A3B8'}],
        income: [{id:'pollo_venta',name:'Venta Pollo',icon:'ðŸ’°',color:'#34D399'},{id:'trading',name:'Trading',icon:'ðŸ“ˆ',color:'#818CF8'},{id:'salary',name:'Otros',icon:'ðŸ’µ',color:'#CBD5E1'}]
    },
    recurring: [],
    view: 'dashboard',
    month: new Date().getMonth(),
    year: new Date().getFullYear(),
    cur: 'MXN',
    modal: null,
    gd: {ok: false, at: null, fid: null}
};

// --- DRIVE ---
async function iGD(){
    if(!window.google) return;
    S.gd.tc = google.accounts.oauth2.initTokenRequest({
        client_id: GC, scope: DS, callback: async (r) => {
            S.gd.at = r.access_token; S.gd.ok = true; 
            await fFile(); await ldDr(); R();
        }
    });
}
async function fFile(){
    try {
        const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DF}' and trashed=false`, {headers:{'Authorization':`Bearer ${S.gd.at}`}});
        const d = await r.json();
        if(d.files?.length) S.gd.fid = d.files[0].id;
        else await cFile();
    } catch(e) { console.error(e); }
}
async function cFile(){
    const meta = {name: DF, mimeType: 'application/json'};
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
    form.append('file', new Blob([JSON.stringify({transactions:[], recurring:[]})], {type: 'application/json'}));
    const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST', headers:{'Authorization':`Bearer ${S.gd.at}`}, body:form
    });
    const d = await r.json();
    S.gd.fid = d.id;
}
async function ldDr(){
    if(!S.gd.fid) return;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${S.gd.fid}?alt=media`, {headers:{'Authorization':`Bearer ${S.gd.at}`}});
    const d = await r.json();
    if(d) { S.transactions = d.transactions || []; S.recurring = d.recurring || []; pRec(); }
}
async function svDr(){
    if(!S.gd.fid) return;
    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${S.gd.fid}?uploadType=media`, {
        method:'PATCH', headers:{'Authorization':`Bearer ${S.gd.at}`, 'Content-Type':'application/json'},
        body: JSON.stringify({transactions: S.transactions, recurring: S.recurring})
    });
}

// --- RECURRENTE ---
function pRec(){
    const td = new Date(); td.setHours(0,0,0,0);
    let ch = false;
    S.recurring.forEach(r => {
        let nx = new Date(r.nextDate + 'T12:00:00');
        while(nx <= td){
            S.transactions.push({id:Date.now()+Math.random(), type:r.type, amount:r.amount, currency:r.currency, date:nx.
